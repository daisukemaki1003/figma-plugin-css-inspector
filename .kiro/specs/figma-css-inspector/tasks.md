# Implementation Plan

## Tasks

- [x] 1. プロジェクト基盤のセットアップ
- [x] 1.1 Figmaプラグインプロジェクトの初期化
  - TypeScriptとReactを使用したFigmaプラグインの基盤を構築する
  - manifest.jsonでプラグイン名、ID、UIファイルを設定する
  - esbuildでMain Thread用とUI用の2つのビルドターゲットを設定する
  - @figma/plugin-typingsをインストールし、tsconfig.jsonを設定する
  - 開発用のwatch modeとプロダクションビルドスクリプトを用意する
  - _Requirements: 5.2, 6.2_

- [x] 1.2 (P) 共通型定義の作成
  - プラグイン全体で使用するデータ型を定義する
  - CSSプロパティ、カテゴリ、分類済みCSSの型を作成する
  - Main ThreadとUI間のメッセージ型を定義する
  - エラーメッセージ型を定義する
  - _Requirements: 4.1_

- [ ] 2. Main Thread側のコア機能実装
- [x] 2.1 選択監視機能の実装
  - Figmaの選択変更イベントを監視する機能を作成する
  - ユーザーがノードを選択したときにコールバックを呼び出す
  - 複数ノード選択時は最初のノードのみを処理対象とする
  - 選択解除時はnullを通知する
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 2.2 CSS抽出機能の実装
  - 選択されたノードからgetCSSAsyncを使用してCSSを取得する
  - 取得したCSSを6つのカテゴリに分類する（レイアウト、スペーシング、タイポグラフィ、カラー、ボーダー、エフェクト）
  - 各カテゴリ内のプロパティを論理的な順序でソートする
  - getCSSAsyncをサポートしないノードタイプのエラーハンドリングを実装する
  - _Requirements: 2.1, 2.4, 4.1, 4.2, 4.3, 4.4, 4.5, 6.1_

- [ ] 2.3 プラグインコントローラーの実装
  - プラグイン起動時にUIを表示する
  - 選択監視を開始し、選択変更時にCSS抽出を実行する
  - 抽出結果をUIにメッセージとして送信する
  - 未選択状態やエラー状態もUIに通知する
  - UIからのメッセージを受信して処理する
  - _Requirements: 1.1, 1.3, 1.4, 6.3_

- [ ] 3. UI側のコア機能実装
- [ ] 3.1 (P) Reactアプリケーションの基盤構築
  - ReactルートコンポーネントとエントリーポイントHTMLを作成する
  - Main Threadからのメッセージを受信する仕組みを実装する
  - アプリケーション状態（CSSデータ、ローディング、エラー）を管理する
  - Figmaのテーマ（ライト/ダーク）に対応したベーススタイルを設定する
  - _Requirements: 5.1_

- [ ] 3.2 (P) カテゴリパネルコンポーネントの作成
  - カテゴリヘッダーとプロパティリストを表示するコンポーネントを作成する
  - ヘッダークリックで折りたたみ/展開を切り替える機能を実装する
  - 空のカテゴリは非表示にする
  - カテゴリ単位でのコピーボタンを配置する
  - _Requirements: 2.1, 2.2, 2.3, 3.2_

- [ ] 3.3 (P) プロパティ表示コンポーネントの作成
  - 個別のCSSプロパティを表示するコンポーネントを作成する
  - プロパティ名と値を視覚的に区別して表示する
  - モノスペースフォントでコードを表示する
  - クリックで個別プロパティをコピーする機能を実装する
  - 幅が狭い場合の折り返し表示を実装する
  - _Requirements: 3.1, 5.3, 5.4, 5.5_

- [ ] 3.4 (P) 空状態・エラー状態コンポーネントの作成
  - ノード未選択時のガイダンスメッセージを表示するコンポーネントを作成する
  - エラー発生時のエラーメッセージを表示するコンポーネントを作成する
  - ローディング状態の表示を実装する
  - _Requirements: 1.3, 6.3_

- [ ] 4. コピー機能とフィードバック
- [ ] 4.1 コピー機能の実装
  - Clipboard APIを使用してテキストをコピーする機能を作成する
  - 個別プロパティ、カテゴリ単位、全体のコピーをサポートする
  - 複数プロパティをコピーする際は改行区切りでフォーマットする
  - コピー成功/失敗の結果を返す
  - _Requirements: 3.1, 3.2, 3.3_

- [ ] 4.2 トースト通知の実装
  - コピー完了を通知するトーストコンポーネントを作成する
  - 成功と失敗で異なるスタイルを適用する
  - 2秒後に自動的に消える
  - 画面右下に表示する
  - _Requirements: 3.4_

- [ ] 5. 全体コピーとUI仕上げ
- [ ] 5.1 ヘッダーと全体コピー機能の実装
  - プラグインヘッダーにノード名とタイプを表示する
  - 全カテゴリの全プロパティをまとめてコピーするボタンを配置する
  - コピーボタンにアイコンとツールチップを追加する
  - _Requirements: 3.3, 5.1_

- [ ] 5.2 UIスタイリングの仕上げ
  - Figmaのデザインシステムに調和したカラースキームを適用する
  - ホバー、フォーカス、アクティブ状態のスタイルを実装する
  - レスポンシブ対応でウィンドウリサイズ時のレイアウト調整を行う
  - アクセシビリティ対応（フォーカス可視化、適切なコントラスト）を実装する
  - _Requirements: 5.1, 5.2, 5.5_

- [ ] 6. 統合とテスト
- [ ] 6.1 全体統合
  - Main ThreadとUIの接続を確認し、エンドツーエンドで動作させる
  - 選択変更からCSS表示までのフローを検証する
  - 各コピー機能が正しく動作することを確認する
  - エラーケース（未選択、非対応ノード）の動作を確認する
  - _Requirements: 1.1, 1.3, 1.4, 6.1, 6.3_

- [ ] 6.2 パフォーマンス最適化
  - CSS抽出が500ms以内に完了することを確認する
  - 不要な再レンダリングを防ぐためReact.memoを適用する
  - Figma本体のパフォーマンスに影響がないことを確認する
  - _Requirements: 6.1, 6.2_

- [ ]* 6.3 ユニットテストの作成
  - CSS抽出ロジックのテストを作成する（カテゴリ分類、ソート）
  - コピー機能のテストを作成する（フォーマット出力）
  - メッセージ型ガードのテストを作成する
  - _Requirements: 2.1, 2.4, 3.1, 4.1_
